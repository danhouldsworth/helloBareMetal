#include <avr/io.h>
#include <avr/pgmspace.h>
#define _NOP() __asm__ __volatile__("nop");
#define WIDTH (128*1)
#define HEIGHT (64*2)

const uint8_t bootOLED[] PROGMEM = {0xD5,0x80,0x8D,0x14,0x20,0x00,0x81,0xFF,0xAF};
const uint8_t bigPhoto[ WIDTH * (HEIGHT / 8)] PROGMEM = {63,63,127,255,255,124,3,7,255,255,255,255,0,0,0,2,6,6,30,31,63,127,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127,127,127,127,127,127,63,127,255,255,255,127,255,191,175,15,7,7,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127,1,0,0,3,3,3,3,1,3,3,131,3,7,3,1,224,128,0,0,0,0,0,0,255,255,255,7,0,0,0,0,0,0,0,0,0,0,0,0,1,1,3,7,7,15,31,31,63,127,127,255,255,255,255,255,127,63,31,63,63,63,63,63,63,63,31,31,15,15,15,15,15,31,63,127,127,255,255,243,51,255,191,191,63,127,39,62,126,47,14,30,254,252,254,126,254,254,255,127,63,28,0,1,0,0,0,63,255,63,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,63,63,31,2,0,0,0,96,128,0,0,0,0,0,0,0,0,96,48,15,0,0,0,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,4,14,254,220,194,128,200,120,50,1,3,2,32,2,16,0,0,0,0,224,244,102,38,0,3,3,3,34,99,35,1,1,136,200,241,240,88,8,0,0,0,0,0,4,126,255,223,159,223,255,255,255,251,254,255,255,255,255,255,255,255,206,206,159,59,0,0,0,0,0,0,128,128,128,128,0,0,192,240,240,240,3,0,0,0,0,0,0,0,0,1,15,127,224,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,0,137,201,193,192,192,4,31,24,30,19,6,28,4,32,32,0,5,3,129,0,0,0,8,8,4,0,2,6,4,0,1,1,128,128,0,0,0,0,0,128,224,252,255,255,255,159,15,7,63,255,255,127,255,255,255,255,255,255,255,255,255,255,254,248,248,240,240,224,224,204,216,188,63,31,255,255,255,253,0,0,0,0,0,0,224,32,112,120,56,48,49,0,0,128,128,0,0,0,0,64,0,0,0,64,0,0,0,0,0,0,0,0,0,0,64,0,64,0,0,0,0,0,0,0,124,252,252,248,248,240,241,225,225,198,134,130,0,0,0,0,0,0,48,48,25,25,27,1,192,192,0,0,0,2,128,0,0,0,0,0,0,0,0,0,0,48,248,251,255,63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,0,1,253,253,255,255,255,255,255,255,255,255,255,255,255,255,0,0,0,0,0,14,15,7,7,114,252,252,254,254,255,255,255,255,255,255,254,252,248,240,224,192,0,128,0,0,1,1,0,0,0,0,128,0,0,0,0,0,0,0,0,128,16,255,255,255,255,255,255,255,255,255,255,255,255,255,254,252,252,252,248,240,224,224,224,192,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,131,255,255,255,252,248,249,243,231,223,255,159,191,127,255,255,255,255,255,255,255,255,255,255,255,228,198,255,255,255,255,255,255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,160,0,0,1,1,3,135,19,67,131,1,1,1,1,5,3,143,143,199,199,231,230,246,228,196,128,0,0,0,0,0,2,0,0,0,0,0,128,0,0,88,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,252,248,112,0,0,0,0,0,192,224,248,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,252,253,249,241,241,243,231,231,239,63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,4,0,12,12,4,36,193,192,192,32,240,255,159,63,159,159,235,219,154,122,249,255,255,255,255,255,255,255,255,255,255,255,254,0,0,0,0,0,0,0,0,0,0,0,0,128,0,1,31,255,255,255,255,255,255,61,55,239,239,223,31,191,191,191,191,255,255,255,255,255,255,255,255,255,7,131,128,128,0,0,2,226,243,255,255,251,251,251,251,255,255,255,255,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,239,207,0,252,255,255,255,255,255,255,255,255,255,255,255,255,255,4,0,0,0,0,0,254,255,255,0,231,255,255,254,0,129,231,255,255,191,248,240,225,3,7,3,15,15,7,7,3,3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,3,29,255,255,255,8,240,255,255,63,56,120,248,255,255,255,255,255,255,255,255,255,255,255,155,153,223,255,224,224,247,247,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,252,255,255,255,255,255,255,255,255,255,255,255,223,255,255,0,0,128,224,240,60,31,31,31,62,63,63,63,127,126,127,63,231,241,255,31,15,67,96,128,16,152,96,144,128,0,4,16,0,144,0,224,0,0,0,0,1,0,0,0,2,0,0,64,0,0,0,0,1,7,10,31,127,255,0,128,248,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,191,127,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,191,63,191,255,255,255,255,255,56,31,23,19,145,16,32,32,32,0,0,0,0,128,0,192,64,112,4,238,239,103,235,253,251,59,24,135,99,25,0,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,157,255,255,191,255,255,255,255,255,255,255,255,255,255,223,255,255,63,255,255,249,1,111,239,255,255,254,251,251,223,159,62,126,255,255,239,255,255,63,255,255,231,207,31,127,255,127,127,223,223,223,223,191,191,255,191,191,191,63,223,255,191,127,127,255,255,255,255,8,8,0,5,1,1,1,1,1,1,1,0,0,0,0,161,144,33,191,156,126,179,254,54,28,6,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,27,255,223,255,255,255,15,7,3,1,1,1,0,0,0,0,0,1,3,60,248,249,251,251,251,191,31,31,152,144,216,248,249,247,247,119,119,3,1,1,3,3,2,6,14,28,26,31,15,31,63,63,63,63,255,255,255,223,87,247,251,255,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,1,0,19,15,7,1,0,128,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,243,255,242,192,224,192,0,0,0,0,0,0,0,0,128,128,0,128,255,255,127,63,31,15,5,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,3,7,30,60,120,224,192,128,0,0,0,0,0,0,3,3,3,31,63,63,127,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,192,128,159,62,63,15,63,127,127,222,192,192,224,240,240,255,255,255,15,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,7,14,30,62,60,0,0,0,0,0,0,0,0,3,31,15,224,240,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,14,6,15,15,15,15,3,3,129,131,207,239,231,207,191,255,47,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,60,28,2,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,0,0,0,0,0,0,1,255,255,255,31,15,3,0,128,128,192,192,224,224,224,96,96,96,96,112,112,112,120,120,248,248,248,248,240,240,240,224,224,224,224,224,224,224,192,192,192,128,128,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

void writeSPIstream(const uint8_t *ptr, uint16_t count){
    while(count--){
        SPDR = pgm_read_byte(ptr++);
        while(!(SPSR & (1<<SPIF)));
    }
}

int main(void){
    PORTD = DDRD = (1 << DDD3) | (1 << DDD4);               // Reset / OLED DC
    PORTB = DDRB = (1 << DDB3) | (1 << DDB5) | (1 << DDB2); // MOSI SCK SS
    SPCR = (1 << SPE) | (1 << MSTR);
    SPSR = (1 << SPI2X);

    PORTD &= ~(1 << PORTD4); // OLED 'Commands'
    PORTB &= ~(1 << PORTB2);
    writeSPIstream(&bootOLED[0],9);
    PORTB |=  (1 << PORTB2);

    PORTD |=  (1 << PORTD4); // OLED 'Data'
    PORTB &= ~(1 << PORTB2);

    uint8_t bitIndex;
    for(;;){
        for (uint16_t y = 0; y < HEIGHT-64; y++){
            bitIndex = y & 0x7;
            for (uint8_t col = y >> 3; col < (y>>3) + 8; col++){
                for (uint16_t x = 0; x < 128; x++){
                   SPDR = (pgm_read_byte(&bigPhoto[x + col*WIDTH]) >> bitIndex) + (pgm_read_byte(&bigPhoto[x + (col+1)*WIDTH]) << (8-bitIndex));
                   while(!(SPSR & (1<<SPIF)));
                }
            }
           // for(uint32_t delay = 0; delay < 10000; delay++) {_NOP();}
        }
        for (uint16_t y = HEIGHT-64; y > 0; y--){
            bitIndex = y & 0x7;
            for (uint8_t col = y >> 3; col < (y>>3) + 8; col++){
                for (uint16_t x = 0; x < 128; x++){
                   SPDR = (pgm_read_byte(&bigPhoto[x + col*WIDTH]) >> bitIndex) + (pgm_read_byte(&bigPhoto[x + (col+1)*WIDTH]) << (8-bitIndex));
                   while(!(SPSR & (1<<SPIF)));
                }
            }
           // for(uint32_t delay = 0; delay < 10000; delay++) {_NOP();}
        }

    }
}
